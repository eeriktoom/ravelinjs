<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>send test</title>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <h1>send test</h1>

  <h2>Output</h2>
  <pre id="output"></pre>
  <h2>Output Error</h2>
  <pre id="error"></pre>

  <script src="../common.js"></script>
  <script src="./ravelin.js"></script>
  <script>
    run(function() {
      // Send a "msg" error report to http://api/?key.
      var q = parseQuery(window.location.search);
      var r = new Ravelin({
        api: q.api || '/',
        key: q.key || 'hello'
      });
      try {
        throw new Error(q.msg);
      } catch(e) {
        var failures = [];
        function attemptSend(e, n) {
          return r.core.reportError(e).then(
            function success() {
              return {
                attempts: n,
                failures: failures
              };
            },
            function failure(err) {
              // BrowserStackLocal seems to be injecting some 400s into
              // responses. The request arrives at our server with an incomplete
              // request body. Lets just try sending the request again.
              failures.push(err);
              return attemptSend(e, n+1);
            }
          );
        }
        return attemptSend(e, 1);
      }
    }).then(done, done);
  </script>
</body>
</html>
